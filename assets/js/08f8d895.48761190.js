"use strict";(self.webpackChunkautomata_docs=self.webpackChunkautomata_docs||[]).push([[6823],{3774:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>r});var t=s(6672);const i={},a=t.createContext(i);function d(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),t.createElement(a.Provider,{value:n},e.children)}},4640:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>d,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"automata-signal/designs/DESIGN-003-data-model","title":"[DESIGN-003] \ub370\uc774\ud130 \ubaa8\ub378","description":"| \ubc84\uc804 | \ub0a0\uc9dc       | \ubcc0\uacbd \ub0b4\uc6a9      |","source":"@site/docs/automata-signal/2-designs/DESIGN-003-data-model.md","sourceDirName":"automata-signal/2-designs","slug":"/automata-signal/designs/DESIGN-003-data-model","permalink":"/automata_docs/docs/automata-signal/designs/DESIGN-003-data-model","draft":false,"unlisted":false,"editUrl":"https://github.com/AutomataOOO/automata_docs/tree/main/docs/automata-signal/2-designs/DESIGN-003-data-model.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docSidebar","previous":{"title":"[DESIGN-002] \uc2dc\uc2a4\ud15c \uc544\ud0a4\ud14d\ucc98","permalink":"/automata_docs/docs/automata-signal/designs/DESIGN-002-system-architecture"},"next":{"title":"[DESIGN-004] \ubc30\ud3ec \uad6c\uc870","permalink":"/automata_docs/docs/automata-signal/designs/DESIGN-004-deployment"}}');var i=s(3420),a=s(3774);const d={},r="[DESIGN-003] \ub370\uc774\ud130 \ubaa8\ub378",c={},l=[{value:"\uad00\ub828 \ubb38\uc11c",id:"\uad00\ub828-\ubb38\uc11c",level:2},{value:"\uc694\uc57d",id:"\uc694\uc57d",level:2},{value:"\ub300\uc0c1 \ub3c5\uc790",id:"\ub300\uc0c1-\ub3c5\uc790",level:2},{value:"1. \uac1c\ub150\uc801 \ub370\uc774\ud130 \ubaa8\ub378",id:"1-\uac1c\ub150\uc801-\ub370\uc774\ud130-\ubaa8\ub378",level:2},{value:"1.1 \uac1c\uccb4 \uad00\uacc4 \ub2e4\uc774\uc5b4\uadf8\ub7a8",id:"11-\uac1c\uccb4-\uad00\uacc4-\ub2e4\uc774\uc5b4\uadf8\ub7a8",level:3},{value:"1.2 \uc0c1\uc138 ERD",id:"12-\uc0c1\uc138-erd",level:3},{value:"2. \ud575\uc2ec \ub9ac\uc18c\uc2a4 \uc815\uc758",id:"2-\ud575\uc2ec-\ub9ac\uc18c\uc2a4-\uc815\uc758",level:2},{value:"2.1 Application",id:"21-application",level:3},{value:"2.2 User",id:"22-user",level:3},{value:"2.3 Subscription",id:"23-subscription",level:3},{value:"2.4 Message",id:"24-message",level:3},{value:"2.5 MessageEvent",id:"25-messageevent",level:3},{value:"2.6 SubscriptionEvent",id:"26-subscriptionevent",level:3},{value:"2.7 MessageTemplate",id:"27-messagetemplate",level:3},{value:"2.8 MessageCampaign",id:"28-messagecampaign",level:3},{value:"2.9 MessageQuota",id:"29-messagequota",level:3},{value:"3. \ub370\uc774\ud130\ubca0\uc774\uc2a4 \uc2a4\ud0a4\ub9c8",id:"3-\ub370\uc774\ud130\ubca0\uc774\uc2a4-\uc2a4\ud0a4\ub9c8",level:2},{value:"3.1 \ud14c\uc774\ube14 \uad6c\uc870",id:"31-\ud14c\uc774\ube14-\uad6c\uc870",level:3},{value:"3.2 \uc778\ub371\uc2a4 \uc804\ub7b5",id:"32-\uc778\ub371\uc2a4-\uc804\ub7b5",level:3},{value:"3.3 \ud30c\ud2f0\uc154\ub2dd \uc804\ub7b5",id:"33-\ud30c\ud2f0\uc154\ub2dd-\uc804\ub7b5",level:3},{value:"4. \ub370\uc774\ud130 \uad00\uacc4 \ubc0f \uc81c\uc57d\uc870\uac74",id:"4-\ub370\uc774\ud130-\uad00\uacc4-\ubc0f-\uc81c\uc57d\uc870\uac74",level:2},{value:"4.1 \uc8fc\uc694 \uad00\uacc4",id:"41-\uc8fc\uc694-\uad00\uacc4",level:3},{value:"4.2 \uc911\uc694 \uc81c\uc57d\uc870\uac74",id:"42-\uc911\uc694-\uc81c\uc57d\uc870\uac74",level:3},{value:"5. \ub370\uc774\ud130 \ub9c8\uc774\uadf8\ub808\uc774\uc158 \ubc0f \uc9c4\ud654",id:"5-\ub370\uc774\ud130-\ub9c8\uc774\uadf8\ub808\uc774\uc158-\ubc0f-\uc9c4\ud654",level:2},{value:"5.1 \uc2a4\ud0a4\ub9c8 \ubcc0\uacbd \uc804\ub7b5",id:"51-\uc2a4\ud0a4\ub9c8-\ubcc0\uacbd-\uc804\ub7b5",level:3},{value:"5.2 \ub9c8\uc774\uadf8\ub808\uc774\uc158 \uac00\uc774\ub4dc\ub77c\uc778",id:"52-\ub9c8\uc774\uadf8\ub808\uc774\uc158-\uac00\uc774\ub4dc\ub77c\uc778",level:3},{value:"5.3 \ubc84\uc804 \uad00\ub9ac",id:"53-\ubc84\uc804-\uad00\ub9ac",level:3},{value:"6. \uc131\ub2a5 \ucd5c\uc801\ud654",id:"6-\uc131\ub2a5-\ucd5c\uc801\ud654",level:2},{value:"6.1 \uc870\ud68c \ucd5c\uc801\ud654",id:"61-\uc870\ud68c-\ucd5c\uc801\ud654",level:3},{value:"6.2 \uc785\ub825/\uc218\uc815 \ucd5c\uc801\ud654",id:"62-\uc785\ub825\uc218\uc815-\ucd5c\uc801\ud654",level:3},{value:"6.3 \uc2e4\ud589 \uacc4\ud68d \ubd84\uc11d",id:"63-\uc2e4\ud589-\uacc4\ud68d-\ubd84\uc11d",level:3},{value:"6.4 \ub300\ub7c9 \ucffc\ub9ac \uc804\ub7b5",id:"64-\ub300\ub7c9-\ucffc\ub9ac-\uc804\ub7b5",level:3},{value:"7. \ubcf4\uc548 \uace0\ub824\uc0ac\ud56d",id:"7-\ubcf4\uc548-\uace0\ub824\uc0ac\ud56d",level:2},{value:"7.1 \ubbfc\uac10 \ub370\uc774\ud130 \ucc98\ub9ac",id:"71-\ubbfc\uac10-\ub370\uc774\ud130-\ucc98\ub9ac",level:3},{value:"7.2 \uc811\uadfc \uc81c\uc5b4",id:"72-\uc811\uadfc-\uc81c\uc5b4",level:3},{value:"7.3 \uac10\uc0ac \ucd94\uc801",id:"73-\uac10\uc0ac-\ucd94\uc801",level:3},{value:"8. \ub370\uc774\ud130 \ub9c8\uc774\uadf8\ub808\uc774\uc158 \uc2a4\ud06c\ub9bd\ud2b8",id:"8-\ub370\uc774\ud130-\ub9c8\uc774\uadf8\ub808\uc774\uc158-\uc2a4\ud06c\ub9bd\ud2b8",level:2},{value:"8.1 \uae30\ubcf8 \uc2a4\ud0a4\ub9c8 \uc0dd\uc131",id:"81-\uae30\ubcf8-\uc2a4\ud0a4\ub9c8-\uc0dd\uc131",level:3},{value:"8.2 \ud14c\uc774\ube14 \ud30c\ud2f0\uc154\ub2dd \ub9c8\uc774\uadf8\ub808\uc774\uc158",id:"82-\ud14c\uc774\ube14-\ud30c\ud2f0\uc154\ub2dd-\ub9c8\uc774\uadf8\ub808\uc774\uc158",level:3},{value:"9. \ub370\uc774\ud130 \ubaa8\ub378 \uc0ac\uc6a9 \uc608\uc2dc",id:"9-\ub370\uc774\ud130-\ubaa8\ub378-\uc0ac\uc6a9-\uc608\uc2dc",level:2},{value:"9.1 \uad6c\ub3c5 \ub4f1\ub85d",id:"91-\uad6c\ub3c5-\ub4f1\ub85d",level:3},{value:"9.2 \uba54\uc2dc\uc9c0 \uc804\uc1a1",id:"92-\uba54\uc2dc\uc9c0-\uc804\uc1a1",level:3},{value:"9.3 \ucea0\ud398\uc778 \uc0dd\uc131 \ubc0f \uc2e4\ud589",id:"93-\ucea0\ud398\uc778-\uc0dd\uc131-\ubc0f-\uc2e4\ud589",level:3}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"design-003-\ub370\uc774\ud130-\ubaa8\ub378",children:"[DESIGN-003] \ub370\uc774\ud130 \ubaa8\ub378"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\ubc84\uc804"}),(0,i.jsx)(n.th,{children:"\ub0a0\uc9dc"}),(0,i.jsx)(n.th,{children:"\ubcc0\uacbd \ub0b4\uc6a9"})]})}),(0,i.jsx)(n.tbody,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"1.0"}),(0,i.jsx)(n.td,{children:"2025-04-02"}),(0,i.jsx)(n.td,{children:"\ucd5c\ucd08 \ubb38\uc11c \uc791\uc131"})]})})]}),"\n",(0,i.jsx)(n.h2,{id:"\uad00\ub828-\ubb38\uc11c",children:"\uad00\ub828 \ubb38\uc11c"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"[DESIGN-001] \uc544\ud0a4\ud14d\ucc98 \uac1c\uc694"}),"\n",(0,i.jsx)(n.li,{children:"[DESIGN-002] \uc2dc\uc2a4\ud15c \uc544\ud0a4\ud14d\ucc98"}),"\n",(0,i.jsx)(n.li,{children:"[REF-002] \uc0c1\ud0dc \ucf54\ub4dc"}),"\n",(0,i.jsx)(n.li,{children:"[COMP-002] \uc5b4\ub311\ud130 \uc2dc\uc2a4\ud15c"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\uc694\uc57d",children:"\uc694\uc57d"}),"\n",(0,i.jsx)(n.p,{children:"\ubcf8 \ubb38\uc11c\ub294 Automata-Signal \uc2dc\uc2a4\ud15c\uc758 \ub370\uc774\ud130 \ubaa8\ub378\uc744 \uc0c1\uc138\ud788 \uc124\uba85\ud569\ub2c8\ub2e4. Ash Framework\ub97c \uc0ac\uc6a9\ud558\uc5ec \uad6c\ud604\ub41c \ud575\uc2ec \ub9ac\uc18c\uc2a4, \uadf8\ub4e4\uc758 \uc18d\uc131, \uad00\uacc4 \ubc0f \ube44\uc988\ub2c8\uc2a4 \uaddc\uce59\uc744 \ud3ec\ud568\ud569\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.h2,{id:"\ub300\uc0c1-\ub3c5\uc790",children:"\ub300\uc0c1 \ub3c5\uc790"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\ubc31\uc5d4\ub4dc \uac1c\ubc1c\uc790"}),"\n",(0,i.jsx)(n.li,{children:"\ub370\uc774\ud130\ubca0\uc774\uc2a4 \uad00\ub9ac\uc790"}),"\n",(0,i.jsx)(n.li,{children:"\uc2dc\uc2a4\ud15c \uc544\ud0a4\ud14d\ud2b8"}),"\n",(0,i.jsx)(n.li,{children:"API \uac1c\ubc1c\uc790"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"1-\uac1c\ub150\uc801-\ub370\uc774\ud130-\ubaa8\ub378",children:"1. \uac1c\ub150\uc801 \ub370\uc774\ud130 \ubaa8\ub378"}),"\n",(0,i.jsx)(n.h3,{id:"11-\uac1c\uccb4-\uad00\uacc4-\ub2e4\uc774\uc5b4\uadf8\ub7a8",children:"1.1 \uac1c\uccb4 \uad00\uacc4 \ub2e4\uc774\uc5b4\uadf8\ub7a8"}),"\n",(0,i.jsx)(n.p,{children:"Automata-Signal \uc2dc\uc2a4\ud15c\uc758 \ud575\uc2ec \ub370\uc774\ud130 \ubaa8\ub378\uc744 \uac1c\uccb4-\uad00\uacc4 \ub2e4\uc774\uc5b4\uadf8\ub7a8\uc73c\ub85c \ud45c\ud604\ud569\ub2c8\ub2e4:"}),"\n",(0,i.jsx)(n.mermaid,{value:'erDiagram\n    APPLICATION ||--o{ USER : "has"\n    APPLICATION ||--o{ SUBSCRIPTION : "has"\n    APPLICATION ||--o{ MESSAGE : "sends"\n    APPLICATION ||--o{ SUBSCRIPTION_EVENT : "has"\n    APPLICATION ||--o{ MESSAGE_QUOTA : "has"\n    APPLICATION ||--o{ MESSAGE_TEMPLATE : "has"\n    APPLICATION ||--o{ MESSAGE_CAMPAIGN : "has"\n    USER ||--o{ SUBSCRIPTION : "has"\n    USER ||--o{ MESSAGE : "receives"\n    SUBSCRIPTION ||--o{ MESSAGE : "receives"\n    MESSAGE ||--o{ MESSAGE_EVENT : "generates"\n    USER ||--o{ SUBSCRIPTION_EVENT : "has"\n    SUBSCRIPTION ||--o{ SUBSCRIPTION_EVENT : "has"\n    MESSAGE_TEMPLATE ||--o{ MESSAGE_CAMPAIGN : "used_by"\n    MESSAGE_CAMPAIGN ||--o{ MESSAGE : "generates"'}),"\n",(0,i.jsx)(n.h3,{id:"12-\uc0c1\uc138-erd",children:"1.2 \uc0c1\uc138 ERD"}),"\n",(0,i.jsx)(n.p,{children:"\uc2dc\uc2a4\ud15c\uc758 \uc8fc\uc694 \uc5d4\ud2f0\ud2f0\uc640 \ubaa8\ub4e0 \ud544\ub4dc\ub97c \ud3ec\ud568\ud55c \uc0c1\uc138 ERD\uc785\ub2c8\ub2e4:"}),"\n",(0,i.jsx)(n.mermaid,{value:'erDiagram\n    APPLICATION {\n        uuid id PK\n        string name\n        string api_key\n        jsonb settings\n        datetime created_at\n        datetime updated_at\n        boolean is_active\n    }\n\n    USER {\n        uuid id PK\n        string external_id\n        uuid application_id FK\n        datetime created_at\n        datetime last_active_at\n        boolean is_archived\n        datetime archived_at\n    }\n    %% Note: (external_id, application_id) must be unique\n\n    SUBSCRIPTION {\n        uuid id PK\n        string token\n        enum type\n        uuid user_id FK\n        uuid application_id FK\n        string device_model\n        string device_os\n        string device_language\n        string app_version\n        string sdk_version\n        string country_code\n        integer test_type\n        jsonb tags\n        integer subscription_status\n        datetime subscribed_at\n        datetime unsubscribed_at\n        datetime last_active_at\n        int total_messages_received\n        int total_messages_converted\n        boolean is_archived\n        datetime archived_at\n    }\n\n    MESSAGE {\n        uuid id PK\n        string title\n        string body\n        jsonb data\n        uuid user_id FK\n        uuid subscription_id FK\n        uuid application_id FK\n        uuid campaign_id FK\n        enum status\n        enum channel_type\n        datetime created_at\n        datetime updated_at\n        datetime sent_at\n        datetime received_at\n        datetime converted_at\n        datetime failed_at\n        string error_reason\n        jsonb error_details\n        jsonb version_history\n    }\n\n    MESSAGE_EVENT {\n        uuid id PK\n        uuid message_id FK\n        enum event_type\n        datetime occurred_at\n        jsonb metadata\n        jsonb version_history\n    }\n\n    SUBSCRIPTION_EVENT {\n        uuid id PK\n        uuid user_id FK\n        uuid subscription_id FK\n        uuid application_id FK\n        enum event_type\n        string channel\n        string source\n        string reason\n        datetime occurred_at\n    }\n\n    MESSAGE_TEMPLATE {\n        uuid id PK\n        uuid application_id FK\n        string name\n        string title_template\n        string body_template\n        jsonb data_template\n        string description\n        datetime created_at\n        datetime updated_at\n        boolean is_active\n        int version\n    }\n\n    MESSAGE_CAMPAIGN {\n        uuid id PK\n        uuid application_id FK\n        uuid template_id FK\n        string name\n        string title\n        string body\n        jsonb data\n        enum campaign_type\n        datetime scheduled_at\n        datetime created_at\n        datetime updated_at\n        datetime sent_at\n        string created_by\n        jsonb targeting_criteria\n        int total_recipients\n        int successful_count\n        int failed_count\n        enum status\n    }\n\n    MESSAGE_QUOTA {\n        uuid id PK\n        uuid application_id FK\n        int daily_quota\n        int monthly_quota\n        int daily_used\n        int monthly_used\n        datetime reset_date\n        decimal unit_price\n        decimal credit_balance\n        string billing_currency\n    }\n\n    OBAN_JOBS {\n        bigserial id PK\n        string state\n        string queue\n        string worker\n        jsonb args\n        jsonb[] errors\n        int attempt\n        int max_attempts\n        datetime inserted_at\n        datetime scheduled_at\n        datetime completed_at\n        datetime attempted_at\n        datetime cancelled_at\n        datetime discarded_at\n        int priority\n        string[] tags\n        jsonb meta\n    }\n\n    APPLICATION ||--o{ USER : "has"\n    APPLICATION ||--o{ SUBSCRIPTION : "has"\n    APPLICATION ||--o{ MESSAGE : "sends"\n    APPLICATION ||--o{ SUBSCRIPTION_EVENT : "has"\n    APPLICATION ||--o{ MESSAGE_QUOTA : "has"\n    APPLICATION ||--o{ MESSAGE_TEMPLATE : "has"\n    APPLICATION ||--o{ MESSAGE_CAMPAIGN : "has"\n    USER ||--o{ SUBSCRIPTION : "has"\n    USER ||--o{ MESSAGE : "receives"\n    SUBSCRIPTION ||--o{ MESSAGE : "receives"\n    MESSAGE ||--o{ MESSAGE_EVENT : "generates"\n    USER ||--o{ SUBSCRIPTION_EVENT : "has"\n    SUBSCRIPTION ||--o{ SUBSCRIPTION_EVENT : "has"\n    MESSAGE_TEMPLATE ||--o{ MESSAGE_CAMPAIGN : "used_by"\n    MESSAGE_CAMPAIGN ||--o{ MESSAGE : "generates"'}),"\n",(0,i.jsx)(n.h2,{id:"2-\ud575\uc2ec-\ub9ac\uc18c\uc2a4-\uc815\uc758",children:"2. \ud575\uc2ec \ub9ac\uc18c\uc2a4 \uc815\uc758"}),"\n",(0,i.jsx)(n.p,{children:"Automata-Signal \uc2dc\uc2a4\ud15c\uc740 \ub2e4\uc74c\uacfc \uac19\uc740 \ud575\uc2ec \ub9ac\uc18c\uc2a4\ub85c \uad6c\uc131\ub429\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.h3,{id:"21-application",children:"2.1 Application"}),"\n",(0,i.jsx)(n.p,{children:"\uba54\uc2dc\uc9d5 \uc11c\ube44\uc2a4\ub97c \uc0ac\uc6a9\ud558\ub294, \uc2dc\uc2a4\ud15c\uc5d0 \ub4f1\ub85d\ub41c \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc744 \ub098\ud0c0\ub0c5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.Application do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :name, :string do\n      constraints [\n        required: true,\n        min_length: 1,\n        max_length: 100\n      ]\n    end\n\n    attribute :api_key, :string do\n      constraints [required: true]\n      sensitive? true\n    end\n\n    attribute :settings, :map, default: %{}\n\n    timestamps()\n\n    attribute :is_active, :boolean, default: true\n  end\n\n  relationships do\n    has_many :users, AutomataSignal.Resources.User\n    has_many :subscriptions, AutomataSignal.Resources.Subscription\n    has_many :messages, AutomataSignal.Resources.Message\n    has_many :templates, AutomataSignal.Resources.MessageTemplate\n    has_many :campaigns, AutomataSignal.Resources.MessageCampaign\n    has_one :quota, AutomataSignal.Resources.MessageQuota\n  end\n\n  actions do\n    defaults [:create, :read, :update, :destroy]\n  end\n\n  # ... \ucd94\uac00 \uc561\uc158 \ubc0f \uc815\ucc45 ...\nend\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc758 \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"name"}),": \uc560\ud50c\ub9ac\ucf00\uc774\uc158 \uc774\ub984"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"api_key"}),": API \ud638\ucd9c \uc778\uc99d\uc5d0 \uc0ac\uc6a9\ub418\ub294 \ud0a4"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"settings"}),": \uc560\ud50c\ub9ac\ucf00\uc774\uc158\ubcc4 \uc124\uc815 (JSON/Map)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"is_active"}),": \uc560\ud50c\ub9ac\ucf00\uc774\uc158 \ud65c\uc131\ud654 \uc0c1\ud0dc"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"22-user",children:"2.2 User"}),"\n",(0,i.jsx)(n.p,{children:"\uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc758 \uc0ac\uc6a9\uc790(\ucd5c\uc885 \uc0ac\uc6a9\uc790)\ub97c \ub098\ud0c0\ub0c5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'defmodule AutomataSignal.Resources.User do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres,\n    extensions: [AshArchival.Resource]\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :external_id, :string do\n      constraints [required: true]\n    end\n\n    attribute :application_id, :uuid do\n      constraints [required: true]\n    end\n\n    attribute :created_at, :utc_datetime\n    attribute :last_active_at, :utc_datetime\n  end\n\n  relationships do\n    belongs_to :application, AutomataSignal.Resources.Application\n    has_many :subscriptions, AutomataSignal.Resources.Subscription\n    has_many :messages, AutomataSignal.Resources.Message\n  end\n\n  # \uc544\uce74\uc774\ube59(\ub17c\ub9ac\uc801 \uc0ad\uc81c) \uc124\uc815\n  archival do\n    archive_attribute :is_archived\n    archive_timestamp_attribute :archived_at\n  end\n\n  # \ubcf5\ud569 \uc720\ub2c8\ud06c \uc81c\uc57d\uc870\uac74\n  postgres do\n    table "users"\n    repo AutomataSignal.Repo\n\n    unique_index [:external_id, :application_id]\n  end\n\n  actions do\n    defaults [:create, :read, :update, :destroy]\n  end\n\n  # ... \ucd94\uac00 \uc561\uc158 \ubc0f \uc815\ucc45 ...\nend\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \ub0b4\ubd80 \uc0ac\uc6a9\uc790 ID (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"external_id"}),": \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc5d0\uc11c \uc0ac\uc6a9\ud558\ub294 \uc678\ubd80 \uc0ac\uc6a9\uc790 ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"application_id"}),": \uc0ac\uc6a9\uc790\uac00 \uc18d\ud55c \uc560\ud50c\ub9ac\ucf00\uc774\uc158"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"created_at"}),": \uc0ac\uc6a9\uc790 \uc0dd\uc131 \uc2dc\uac04"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"last_active_at"}),": \ub9c8\uc9c0\ub9c9 \ud65c\ub3d9 \uc2dc\uac04"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"is_archived"}),": \uc544\uce74\uc774\ube59(\ub17c\ub9ac\uc801 \uc0ad\uc81c) \uc0c1\ud0dc"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\uc911\uc694 \uc81c\uc57d\uc870\uac74"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"external_id"}),"\uc640 ",(0,i.jsx)(n.code,{children:"application_id"}),"\uc758 \uc870\ud569\uc740 \uc720\uc77c\ud574\uc57c \ud568 (\ud55c \uc560\ud50c\ub9ac\ucf00\uc774\uc158 \ub0b4\uc5d0\uc11c \uc0ac\uc6a9\uc790 \uc2dd\ubcc4\uc790\ub294 \uace0\uc720\ud574\uc57c \ud568)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"23-subscription",children:"2.3 Subscription"}),"\n",(0,i.jsx)(n.p,{children:"\uc0ac\uc6a9\uc790\uc758 \uba54\uc2dc\uc9d5 \ucc44\ub110 \uad6c\ub3c5 \uc815\ubcf4\ub97c \ub098\ud0c0\ub0c5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'defmodule AutomataSignal.Resources.Subscription do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres,\n    extensions: [\n      AshArchival.Resource,\n      AshCloak.Resource\n    ]\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :token, :string, sensitive?: true do\n      constraints [required: true]\n    end\n\n    attribute :type, :atom do\n      constraints [\n        required: true,\n        one_of: [:iOSPush, :AndroidPush, :Email, :SMS, :KakaoTalk, :InAppMessage]\n      ]\n    end\n\n    attribute :user_id, :uuid\n    attribute :application_id, :uuid, allow_nil?: false\n\n    # \ub514\ubc14\uc774\uc2a4 \uba54\ud0c0\ub370\uc774\ud130 (\ud478\uc2dc \uc54c\ub9bc \uad6c\ub3c5\uc778 \uacbd\uc6b0)\n    attribute :device_model, :string\n    attribute :device_os, :string\n    attribute :device_language, :string\n    attribute :app_version, :string\n    attribute :sdk_version, :string\n    attribute :country_code, :string\n    attribute :test_type, :integer, default: 0\n\n    # \uad6c\ub3c5 \uc0c1\ud0dc \uad00\ub828 \ud544\ub4dc\n    attribute :subscription_status, :integer, default: 0\n    attribute :subscribed_at, :utc_datetime\n    attribute :unsubscribed_at, :utc_datetime\n\n    # \ud0dc\uadf8 (\uc138\uadf8\uba3c\ud14c\uc774\uc158 \uc6a9\ub3c4)\n    attribute :tags, :map, default: %{}\n\n    # \ud1b5\uacc4 \uc9c0\ud45c\n    attribute :last_active_at, :utc_datetime\n    attribute :total_messages_received, :integer, default: 0\n    attribute :total_messages_converted, :integer, default: 0\n  end\n\n  # \ubbfc\uac10 \ub370\uc774\ud130 \uc554\ud638\ud654\n  encrypted_attributes do\n    attribute :token\n  end\n\n  relationships do\n    belongs_to :user, AutomataSignal.Resources.User\n    belongs_to :application, AutomataSignal.Resources.Application\n    has_many :messages, AutomataSignal.Resources.Message\n    has_many :subscription_events, AutomataSignal.Resources.SubscriptionEvent\n  end\n\n  # \uc544\uce74\uc774\ube59(\ub17c\ub9ac\uc801 \uc0ad\uc81c) \uc124\uc815\n  archival do\n    archive_attribute :is_archived\n    archive_timestamp_attribute :archived_at\n  end\n\n  # \uacc4\uc0b0\ub41c \uc18d\uc131\n  calculations do\n    calculate :is_push_channel, :boolean, expr: expr(type in [:iOSPush, :AndroidPush])\n    calculate :is_messaging_channel, :boolean, expr: expr(type in [:Email, :SMS, :KakaoTalk])\n    calculate :is_in_app_channel, :boolean, expr: expr(type == :InAppMessage)\n\n    calculate :is_subscribed, :boolean, expr: expr(subscription_status > 0)\n    calculate :is_unsubscribed, :boolean, expr: expr(subscription_status == -2 or subscription_status == -31)\n    calculate :has_error, :boolean, expr: expr(subscription_status < -2 and subscription_status != -31 and subscription_status != -99)\n    calculate :error_code_range, :string, expr: expr(\n      cond do\n        subscription_status >= -24 and subscription_status <= -3 -> "push_error"\n        subscription_status >= -49 and subscription_status <= -40 -> "email_error"\n        subscription_status >= -59 and subscription_status <= -50 -> "sms_error"\n        subscription_status >= -69 and subscription_status <= -60 -> "kakao_error"\n        subscription_status >= -79 and subscription_status <= -70 -> "in_app_error"\n        true -> "other"\n      end\n    )\n  end\n\n  actions do\n    defaults [:create, :read, :update, :destroy]\n\n    create :register do\n      accept [:token, :type, :user_id, :application_id, :device_model, :device_os, :device_language, :app_version, :sdk_version, :country_code, :test_type]\n      change set_attribute(:subscription_status, 1)\n      change set_attribute(:subscribed_at, &DateTime.utc_now/0)\n    end\n\n    update :unsubscribe do\n      accept []\n      change set_attribute(:subscription_status, -2)\n      change set_attribute(:unsubscribed_at, &DateTime.utc_now/0)\n    end\n\n    update :add_tags do\n      accept [:tags]\n      argument :new_tags, :map do\n        allow_nil? false\n      end\n\n      change fn changeset, _ ->\n        current_tags = Ash.Changeset.get_attribute(changeset, :tags) || %{}\n        new_tags = Ash.Changeset.get_argument(changeset, :new_tags)\n\n        Ash.Changeset.set_attribute(changeset, :tags, Map.merge(current_tags, new_tags))\n      end\n    end\n  end\nend\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \uad6c\ub3c5\uc758 \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"token"}),": \ucc44\ub110 \ud1a0\ud070 (\ud478\uc2dc \ud1a0\ud070, \uc774\uba54\uc77c \uc8fc\uc18c, \uc804\ud654\ubc88\ud638 \ub4f1)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"type"}),": \uad6c\ub3c5 \ucc44\ub110 \uc720\ud615 (iOSPush, AndroidPush, Email, SMS, KakaoTalk, InAppMessage)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"user_id"}),": \uc5f0\uacb0\ub41c \uc0ac\uc6a9\uc790 ID (\uc775\uba85 \uc0ac\uc6a9\uc790\uc758 \uacbd\uc6b0 null \uac00\ub2a5)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"application_id"}),": \uc5f0\uacb0\ub41c \uc560\ud50c\ub9ac\ucf00\uc774\uc158 ID"]}),"\n",(0,i.jsx)(n.li,{children:"\ub514\ubc14\uc774\uc2a4 \uc815\ubcf4 (device_model, device_os \ub4f1)"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"subscription_status"}),": \uad6c\ub3c5 \uc0c1\ud0dc \ucf54\ub4dc"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"tags"}),": \uc138\uadf8\uba3c\ud14c\uc774\uc158\uc744 \uc704\ud55c \ud0a4-\uac12 \ud0dc\uadf8"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\uc911\uc694 \uc0c1\ud0dc \ucf54\ub4dc"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\uc591\uc218 \uac12(1 \uc774\uc0c1): \uad6c\ub3c5 \ud65c\uc131\ud654 \uc0c1\ud0dc"}),"\n",(0,i.jsx)(n.li,{children:"0, -99: \ucd08\uae30 \uc0c1\ud0dc (\uad6c\ub3c5\ub41c \uc801 \uc5c6\uc74c)"}),"\n",(0,i.jsx)(n.li,{children:"-2: \uc0ac\uc6a9\uc790\uc5d0 \uc758\ud55c \uad6c\ub3c5 \ucde8\uc18c"}),"\n",(0,i.jsx)(n.li,{children:"-31: API\ub97c \ud1b5\ud574 \ube44\ud65c\uc131\ud654\ub428"}),"\n",(0,i.jsx)(n.li,{children:"-3 ~ -24: \ud478\uc2dc \uc54c\ub9bc \uad00\ub828 \uc624\ub958"}),"\n",(0,i.jsx)(n.li,{children:"-40 ~ -49: \uc774\uba54\uc77c \uad00\ub828 \uc624\ub958"}),"\n",(0,i.jsx)(n.li,{children:"-50 ~ -59: SMS \uad00\ub828 \uc624\ub958"}),"\n",(0,i.jsx)(n.li,{children:"-60 ~ -69: \uce74\uce74\uc624\ud1a1 \uad00\ub828 \uc624\ub958"}),"\n",(0,i.jsx)(n.li,{children:"-70 ~ -79: \uc778\uc571 \uba54\uc2dc\uc9c0 \uad00\ub828 \uc624\ub958"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"24-message",children:"2.4 Message"}),"\n",(0,i.jsx)(n.p,{children:"\uc0ac\uc6a9\uc790\uc5d0\uac8c \uc804\uc1a1\ub41c \uac1c\ubcc4 \uba54\uc2dc\uc9c0\ub97c \ub098\ud0c0\ub0c5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.Message do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres,\n    extensions: [AshStateMachine.Resource]\n\n  attributes do\n    uuid_primary_key :id\n\n    # \uba54\uc2dc\uc9c0 \ub0b4\uc6a9\n    attribute :title, :string\n    attribute :body, :string\n    attribute :data, :map, default: %{}\n\n    # \uad00\uacc4 \uc2dd\ubcc4\uc790\n    attribute :user_id, :uuid\n    attribute :subscription_id, :uuid\n    attribute :application_id, :uuid\n    attribute :campaign_id, :uuid, allow_nil?: true\n\n    # \uc0c1\ud0dc \ucd94\uc801\n    attribute :status, :atom do\n      constraints [\n        one_of: [:pending, :successful, :failed, :errored, :received, :converted]\n      ]\n      default :pending\n    end\n\n    attribute :channel_type, :atom do\n      constraints [\n        one_of: [:push, :email, :sms, :kakao_talk, :in_app]\n      ]\n    end\n\n    # \ud0c0\uc784\uc2a4\ud0ec\ud504\n    timestamps()\n    attribute :sent_at, :utc_datetime\n    attribute :received_at, :utc_datetime\n    attribute :converted_at, :utc_datetime\n    attribute :failed_at, :utc_datetime\n\n    # \uc624\ub958 \uc815\ubcf4\n    attribute :error_reason, :string\n    attribute :error_details, :map, default: %{}\n\n    # \uc774\ub825 \ucd94\uc801\n    attribute :version_history, :map, default: %{}\n  end\n\n  # \uc0c1\ud0dc \uba38\uc2e0 \uc815\uc758\n  state_machine do\n    field :status\n\n    initial_states [:pending]\n\n    transitions do\n      transition :send, from: [:pending], to: :successful\n      transition :fail, from: [:pending, :successful], to: :failed\n      transition :error, from: [:pending], to: :errored\n      transition :retry, from: [:errored], to: :pending\n      transition :receive, from: [:successful], to: :received\n      transition :convert, from: [:received], to: :converted\n    end\n\n    on_transition :send do\n      set_attribute :sent_at, &DateTime.utc_now/0\n    end\n\n    on_transition :fail do\n      set_attribute :failed_at, &DateTime.utc_now/0\n    end\n\n    on_transition :receive do\n      set_attribute :received_at, &DateTime.utc_now/0\n    end\n\n    on_transition :convert do\n      set_attribute :converted_at, &DateTime.utc_now/0\n    end\n  end\n\n  relationships do\n    belongs_to :user, AutomataSignal.Resources.User\n    belongs_to :subscription, AutomataSignal.Resources.Subscription\n    belongs_to :application, AutomataSignal.Resources.Application\n    belongs_to :campaign, AutomataSignal.Resources.MessageCampaign, allow_nil?: true\n    has_many :events, AutomataSignal.Resources.MessageEvent\n  end\n\n  actions do\n    defaults [:create, :read, :update]\n\n    create :send_message do\n      accept [:title, :body, :data, :user_id, :subscription_id, :application_id, :campaign_id, :channel_type]\n\n      argument :use_template, :boolean, default: false\n      argument :template_id, :uuid\n      argument :template_variables, :map, default: %{}\n\n      change fn changeset, _ ->\n        if Ash.Changeset.get_argument(changeset, :use_template) do\n          template_id = Ash.Changeset.get_argument(changeset, :template_id)\n          variables = Ash.Changeset.get_argument(changeset, :template_variables)\n\n          # \ud15c\ud50c\ub9bf \ub80c\ub354\ub9c1 \ub85c\uc9c1\n          # ...\n        else\n          changeset\n        end\n      end\n    end\n\n    update :mark_as_sent do\n      accept [:error_reason, :error_details]\n\n      change transition_state(:send)\n    end\n\n    update :mark_as_failed do\n      accept [:error_reason, :error_details]\n\n      change transition_state(:fail)\n    end\n\n    update :mark_as_received do\n      accept []\n\n      change transition_state(:receive)\n      change increment_subscription_counter(:total_messages_received)\n    end\n\n    update :mark_as_converted do\n      accept []\n\n      change transition_state(:convert)\n      change increment_subscription_counter(:total_messages_converted)\n    end\n  end\n\n  defp increment_subscription_counter(changeset, field) do\n    # \uad6c\ub3c5\uc758 \uce74\uc6b4\ud130 \ud544\ub4dc\ub97c \uc99d\uac00\uc2dc\ud0a4\ub294 \ub85c\uc9c1\n    # ...\n  end\nend\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \uba54\uc2dc\uc9c0\uc758 \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"title"}),", ",(0,i.jsx)(n.code,{children:"body"}),": \uba54\uc2dc\uc9c0 \uc81c\ubaa9\uacfc \ubcf8\ubb38"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"data"}),": \ucd94\uac00 \ub370\uc774\ud130 (JSON/Map)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"user_id"}),", ",(0,i.jsx)(n.code,{children:"subscription_id"}),", ",(0,i.jsx)(n.code,{children:"application_id"}),": \uad00\uacc4 \uc2dd\ubcc4\uc790"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"campaign_id"}),": \ucea0\ud398\uc778\uc5d0 \uc758\ud574 \uc0dd\uc131\ub41c \uacbd\uc6b0 \ucea0\ud398\uc778 ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"status"}),": \uba54\uc2dc\uc9c0 \uc0c1\ud0dc (pending, successful, failed, errored, received, converted)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"channel_type"}),": \ucc44\ub110 \uc720\ud615 (push, email, sms, kakao_talk, in_app)"]}),"\n",(0,i.jsxs)(n.li,{children:["\uc2dc\uac04 \ucd94\uc801: ",(0,i.jsx)(n.code,{children:"sent_at"}),", ",(0,i.jsx)(n.code,{children:"received_at"}),", ",(0,i.jsx)(n.code,{children:"converted_at"}),", ",(0,i.jsx)(n.code,{children:"failed_at"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"error_reason"}),", ",(0,i.jsx)(n.code,{children:"error_details"}),": \uc624\ub958 \uc815\ubcf4"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\uba54\uc2dc\uc9c0 \uc0c1\ud0dc"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"pending"}),": \uba54\uc2dc\uc9c0\uac00 \uc0dd\uc131\ub418\uace0 \uc804\uc1a1\uc744 \uae30\ub2e4\ub9ac\ub294 \uc0c1\ud0dc"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"successful"}),": \uc678\ubd80 \uc11c\ube44\uc2a4\uc5d0 \uc131\uacf5\uc801\uc73c\ub85c \uc804\uc1a1\ub428"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"failed"}),": \uba54\uc2dc\uc9c0 \uc804\uc1a1\uc774 \uc2e4\ud328\ud568"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"errored"}),": \uc77c\uc2dc\uc801\uc778 \uc624\ub958\ub85c \uc7ac\uc2dc\ub3c4 \uac00\ub2a5\ud55c \uc0c1\ud0dc"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"received"}),": \uc0ac\uc6a9\uc790 \uae30\uae30\uc5d0 \ub3c4\ub2ec\ud558\uc5ec \uc218\uc2e0\ub428"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"converted"}),": \uc0ac\uc6a9\uc790\uac00 \uba54\uc2dc\uc9c0\ub97c \uc5f4\ub78c\ud558\uac70\ub098 \uc0c1\ud638\uc791\uc6a9\ud568"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"25-messageevent",children:"2.5 MessageEvent"}),"\n",(0,i.jsx)(n.p,{children:"\uba54\uc2dc\uc9c0 \uc0c1\ud0dc \ubcc0\uacbd \uc774\ubca4\ud2b8\ub97c \ucd94\uc801\ud558\ub294 \ub9ac\uc18c\uc2a4\uc785\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.MessageEvent do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres,\n    extensions: [AshPaperTrail.Resource]\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :message_id, :uuid, allow_nil?: false\n\n    attribute :event_type, :atom do\n      constraints [\n        one_of: [:created, :sent, :received, :converted, :failed, :errored, :retried]\n      ]\n    end\n\n    attribute :occurred_at, :utc_datetime\n    attribute :metadata, :map, default: %{}\n  end\n\n  relationships do\n    belongs_to :message, AutomataSignal.Resources.Message\n  end\n\n  # \ubcc0\uacbd \uc774\ub825 \ucd94\uc801 \uc124\uc815\n  paper_trail do\n    track_attribute :event_type\n    track_attribute :metadata\n  end\n\n  actions do\n    defaults [:create, :read]\n  end\nend\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \uc774\ubca4\ud2b8 \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"message_id"}),": \uc5f0\uacb0\ub41c \uba54\uc2dc\uc9c0 ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"event_type"}),": \uc774\ubca4\ud2b8 \uc720\ud615"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"occurred_at"}),": \uc774\ubca4\ud2b8 \ubc1c\uc0dd \uc2dc\uac04"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"metadata"}),": \uc774\ubca4\ud2b8 \uad00\ub828 \ucd94\uac00 \uc815\ubcf4"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"26-subscriptionevent",children:"2.6 SubscriptionEvent"}),"\n",(0,i.jsx)(n.p,{children:"\uad6c\ub3c5 \uc0c1\ud0dc \ubcc0\uacbd \uc774\ubca4\ud2b8\ub97c \ucd94\uc801\ud558\ub294 \ub9ac\uc18c\uc2a4\uc785\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.SubscriptionEvent do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :user_id, :uuid\n    attribute :subscription_id, :uuid, allow_nil?: false\n    attribute :application_id, :uuid, allow_nil?: false\n\n    attribute :event_type, :atom do\n      constraints [\n        one_of: [:created, :subscribed, :unsubscribed, :error, :token_updated, :user_linked, :user_unlinked]\n      ]\n    end\n\n    attribute :channel, :string\n    attribute :source, :string\n    attribute :reason, :string\n    attribute :occurred_at, :utc_datetime\n  end\n\n  relationships do\n    belongs_to :user, AutomataSignal.Resources.User\n    belongs_to :subscription, AutomataSignal.Resources.Subscription\n    belongs_to :application, AutomataSignal.Resources.Application\n  end\n\n  actions do\n    defaults [:create, :read]\n  end\nend\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \uc774\ubca4\ud2b8 \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"user_id"}),", ",(0,i.jsx)(n.code,{children:"subscription_id"}),", ",(0,i.jsx)(n.code,{children:"application_id"}),": \uad00\uacc4 \uc2dd\ubcc4\uc790"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"event_type"}),": \uc774\ubca4\ud2b8 \uc720\ud615"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"channel"}),": \ucc44\ub110 \uc815\ubcf4"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"source"}),": \uc774\ubca4\ud2b8 \uc18c\uc2a4"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"reason"}),": \uc774\ubca4\ud2b8 \ubc1c\uc0dd \uc774\uc720"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"occurred_at"}),": \uc774\ubca4\ud2b8 \ubc1c\uc0dd \uc2dc\uac04"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"27-messagetemplate",children:"2.7 MessageTemplate"}),"\n",(0,i.jsx)(n.p,{children:"\uc7ac\uc0ac\uc6a9 \uac00\ub2a5\ud55c \uba54\uc2dc\uc9c0 \ud15c\ud50c\ub9bf\uc744 \ub098\ud0c0\ub0c5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.MessageTemplate do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :application_id, :uuid, allow_nil?: false\n\n    attribute :name, :string do\n      constraints [required: true]\n    end\n\n    attribute :title_template, :string\n    attribute :body_template, :string\n    attribute :data_template, :map, default: %{}\n\n    attribute :description, :string\n\n    timestamps()\n\n    attribute :is_active, :boolean, default: true\n    attribute :version, :integer, default: 1\n  end\n\n  relationships do\n    belongs_to :application, AutomataSignal.Resources.Application\n    has_many :campaigns, AutomataSignal.Resources.MessageCampaign\n  end\n\n  actions do\n    defaults [:create, :read, :update, :destroy]\n  end\nend\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \ud15c\ud50c\ub9bf \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"application_id"}),": \uc5f0\uacb0\ub41c \uc560\ud50c\ub9ac\ucf00\uc774\uc158 ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"name"}),": \ud15c\ud50c\ub9bf \uc774\ub984"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"title_template"}),", ",(0,i.jsx)(n.code,{children:"body_template"}),": \uc81c\ubaa9 \ubc0f \ubcf8\ubb38 \ud15c\ud50c\ub9bf \ubb38\uc790\uc5f4"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"data_template"}),": \ucd94\uac00 \ub370\uc774\ud130 \ud15c\ud50c\ub9bf (JSON/Map)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"version"}),": \ud15c\ud50c\ub9bf \ubc84\uc804"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"28-messagecampaign",children:"2.8 MessageCampaign"}),"\n",(0,i.jsx)(n.p,{children:"\ub300\ub7c9 \uba54\uc2dc\uc9c0 \ubc1c\uc1a1 \ucea0\ud398\uc778\uc744 \ub098\ud0c0\ub0c5\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.MessageCampaign do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :application_id, :uuid, allow_nil?: false\n    attribute :template_id, :uuid\n\n    attribute :name, :string do\n      constraints [required: true]\n    end\n\n    attribute :title, :string\n    attribute :body, :string\n    attribute :data, :map, default: %{}\n\n    attribute :campaign_type, :atom do\n      constraints [\n        one_of: [:immediate, :scheduled, :triggered]\n      ]\n      default :immediate\n    end\n\n    attribute :scheduled_at, :utc_datetime\n\n    timestamps()\n\n    attribute :sent_at, :utc_datetime\n    attribute :created_by, :string\n\n    attribute :targeting_criteria, :map, default: %{}\n\n    attribute :total_recipients, :integer, default: 0\n    attribute :successful_count, :integer, default: 0\n    attribute :failed_count, :integer, default: 0\n\n    attribute :status, :atom do\n      constraints [\n        one_of: [:draft, :scheduled, :in_progress, :completed, :cancelled, :failed]\n      ]\n      default :draft\n    end\n  end\n\n  relationships do\n    belongs_to :application, AutomataSignal.Resources.Application\n    belongs_to :template, AutomataSignal.Resources.MessageTemplate\n    has_many :messages, AutomataSignal.Resources.Message\n  end\n\n  actions do\n    defaults [:create, :read, :update]\n\n    update :schedule do\n      accept [:scheduled_at]\n\n      change fn changeset, _ ->\n        Ash.Changeset.set_attribute(changeset, :status, :scheduled)\n      end\n    end\n\n    update :execute do\n      accept []\n\n      change fn changeset, _ ->\n        Ash.Changeset.set_attribute(changeset, :status, :in_progress)\n      end\n    end\n\n    update :complete do\n      accept [:successful_count, :failed_count]\n\n      change fn changeset, _ ->\n        Ash.Changeset.set_attribute(changeset, :status, :completed)\n        Ash.Changeset.set_attribute(changeset, :sent_at, DateTime.utc_now())\n      end\n    end\n\n    update :cancel do\n      accept []\n\n      change fn changeset, _ ->\n        Ash.Changeset.set_attribute(changeset, :status, :cancelled)\n      end\n    end\n  end\nend\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \ucea0\ud398\uc778 \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"application_id"}),": \uc5f0\uacb0\ub41c \uc560\ud50c\ub9ac\ucf00\uc774\uc158 ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"template_id"}),": \uc0ac\uc6a9\ud560 \ud15c\ud50c\ub9bf ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"name"}),": \ucea0\ud398\uc778 \uc774\ub984"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"campaign_type"}),": \ucea0\ud398\uc778 \uc720\ud615 (immediate, scheduled, triggered)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"scheduled_at"}),": \uc608\uc57d \uc804\uc1a1 \uc2dc\uac04"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"targeting_criteria"}),": \ub300\uc0c1 \uc0ac\uc6a9\uc790 \ud544\ud130\ub9c1 \uc870\uac74 (JSON/Map)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"status"}),": \ucea0\ud398\uc778 \uc0c1\ud0dc"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"successful_count"}),", ",(0,i.jsx)(n.code,{children:"failed_count"}),": \uc131\uacf5/\uc2e4\ud328 \uba54\uc2dc\uc9c0 \uc218"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"29-messagequota",children:"2.9 MessageQuota"}),"\n",(0,i.jsx)(n.p,{children:"\uc560\ud50c\ub9ac\ucf00\uc774\uc158\ubcc4 \uba54\uc2dc\uc9c0 \ud560\ub2f9\ub7c9 \ubc0f \uc0ac\uc6a9\ub7c9\uc744 \ucd94\uc801\ud569\ub2c8\ub2e4."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'defmodule AutomataSignal.Resources.MessageQuota do\n  use Ash.Resource,\n    data_layer: Ash.DataLayer.Postgres,\n    extensions: [\n      AshMoney.Resource,\n      AshDoubleEntry.Resource\n    ]\n\n  attributes do\n    uuid_primary_key :id\n\n    attribute :application_id, :uuid, allow_nil?: false\n\n    attribute :daily_quota, :integer\n    attribute :monthly_quota, :integer\n\n    attribute :daily_used, :integer, default: 0\n    attribute :monthly_used, :integer, default: 0\n\n    attribute :reset_date, :utc_datetime\n\n    # \uacfc\uae08 \uad00\ub828 \ud544\ub4dc\n    attribute :unit_price, :money\n    attribute :credit_balance, :money, default: 0\n    attribute :billing_currency, :string, default: "KRW"\n  end\n\n  relationships do\n    belongs_to :application, AutomataSignal.Resources.Application\n  end\n\n  # \uc774\uc911 \uc6d0\uc7a5 \uc124\uc815\n  double_entry do\n    account :daily_usage do\n      change_attribute :daily_used\n      credit_type :increase\n      debit_type :decrease\n    end\n\n    account :monthly_usage do\n      change_attribute :monthly_used\n      credit_type :increase\n      debit_type :decrease\n    end\n\n    account :credit_balance do\n      change_attribute :credit_balance\n      credit_type :increase\n      debit_type :decrease\n    end\n  end\n\n  actions do\n    defaults [:read, :update]\n\n    update :add_usage do\n      argument :count, :integer do\n        allow_nil? false\n      end\n\n      change fn changeset, _ ->\n        count = Ash.Changeset.get_argument(changeset, :count)\n\n        changeset\n        |> Ash.Changeset.double_entry_credit(:daily_usage, count)\n        |> Ash.Changeset.double_entry_credit(:monthly_usage, count)\n      end\n    end\n\n    update :reset_daily do\n      change fn changeset, _ ->\n        Ash.Changeset.set_attribute(changeset, :daily_used, 0)\n      end\n    end\n\n    update :reset_monthly do\n      change fn changeset, _ ->\n        Ash.Changeset.set_attribute(changeset, :monthly_used, 0)\n      end\n    end\n\n    update :add_credits do\n      argument :amount, :decimal do\n        allow_nil? false\n      end\n\n      change fn changeset, _ ->\n        amount = Ash.Changeset.get_argument(changeset, :amount)\n\n        Ash.Changeset.double_entry_credit(changeset, :credit_balance, amount)\n      end\n    end\n\n    update :use_credits do\n      argument :amount, :decimal do\n        allow_nil? false\n      end\n\n      change fn changeset, _ ->\n        amount = Ash.Changeset.get_argument(changeset, :amount)\n\n        Ash.Changeset.double_entry_debit(changeset, :credit_balance, amount)\n      end\n    end\n  end\nend\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\ud575\uc2ec \uc18d\uc131"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"id"}),": \ud560\ub2f9\ub7c9 \uace0\uc720 \uc2dd\ubcc4\uc790 (UUID)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"application_id"}),": \uc5f0\uacb0\ub41c \uc560\ud50c\ub9ac\ucf00\uc774\uc158 ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"daily_quota"}),", ",(0,i.jsx)(n.code,{children:"monthly_quota"}),": \uc77c\uc77c/\uc6d4\uac04 \ud560\ub2f9\ub7c9"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"daily_used"}),", ",(0,i.jsx)(n.code,{children:"monthly_used"}),": \uc0ac\uc6a9\ub7c9"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"reset_date"}),": \ub2e4\uc74c \ub9ac\uc14b \uc77c\uc790"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"unit_price"}),": \uba54\uc2dc\uc9c0\ub2f9 \ub2e8\uac00"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"credit_balance"}),": \ub0a8\uc740 \ud06c\ub808\ub527 \uc794\uc561"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-\ub370\uc774\ud130\ubca0\uc774\uc2a4-\uc2a4\ud0a4\ub9c8",children:"3. \ub370\uc774\ud130\ubca0\uc774\uc2a4 \uc2a4\ud0a4\ub9c8"}),"\n",(0,i.jsx)(n.h3,{id:"31-\ud14c\uc774\ube14-\uad6c\uc870",children:"3.1 \ud14c\uc774\ube14 \uad6c\uc870"}),"\n",(0,i.jsx)(n.p,{children:"PostgreSQL \ub370\uc774\ud130\ubca0\uc774\uc2a4\uc5d0 \ub2e4\uc74c\uacfc \uac19\uc740 \ud14c\uc774\ube14 \uad6c\uc870\uac00 \uc0dd\uc131\ub429\ub2c8\ub2e4:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \uc560\ud50c\ub9ac\ucf00\uc774\uc158 \ud14c\uc774\ube14\nCREATE TABLE applications (\n  id UUID PRIMARY KEY,\n  name VARCHAR(100) NOT NULL,\n  api_key VARCHAR(255) NOT NULL,\n  settings JSONB DEFAULT '{}',\n  created_at TIMESTAMP WITH TIME ZONE,\n  updated_at TIMESTAMP WITH TIME ZONE,\n  is_active BOOLEAN DEFAULT TRUE\n);\n\n-- \uc0ac\uc6a9\uc790 \ud14c\uc774\ube14\nCREATE TABLE users (\n  id UUID PRIMARY KEY,\n  external_id VARCHAR(255) NOT NULL,\n  application_id UUID NOT NULL REFERENCES applications(id),\n  created_at TIMESTAMP WITH TIME ZONE,\n  last_active_at TIMESTAMP WITH TIME ZONE,\n  is_archived BOOLEAN DEFAULT FALSE,\n  archived_at TIMESTAMP WITH TIME ZONE,\n  UNIQUE(external_id, application_id)\n);\n\n-- \uad6c\ub3c5 \ud14c\uc774\ube14\nCREATE TABLE subscriptions (\n  id UUID PRIMARY KEY,\n  token TEXT NOT NULL,\n  type VARCHAR(20) NOT NULL,\n  user_id UUID REFERENCES users(id),\n  application_id UUID NOT NULL REFERENCES applications(id),\n  device_model VARCHAR(255),\n  device_os VARCHAR(255),\n  device_language VARCHAR(10),\n  app_version VARCHAR(20),\n  sdk_version VARCHAR(20),\n  country_code VARCHAR(10),\n  test_type INTEGER DEFAULT 0,\n  subscription_status INTEGER DEFAULT 0,\n  subscribed_at TIMESTAMP WITH TIME ZONE,\n  unsubscribed_at TIMESTAMP WITH TIME ZONE,\n  tags JSONB DEFAULT '{}',\n  last_active_at TIMESTAMP WITH TIME ZONE,\n  total_messages_received INTEGER DEFAULT 0,\n  total_messages_converted INTEGER DEFAULT 0,\n  is_archived BOOLEAN DEFAULT FALSE,\n  archived_at TIMESTAMP WITH TIME ZONE\n);\n\n-- \uba54\uc2dc\uc9c0 \ud14c\uc774\ube14\nCREATE TABLE messages (\n  id UUID PRIMARY KEY,\n  title TEXT,\n  body TEXT,\n  data JSONB DEFAULT '{}',\n  user_id UUID REFERENCES users(id),\n  subscription_id UUID REFERENCES subscriptions(id),\n  application_id UUID NOT NULL REFERENCES applications(id),\n  campaign_id UUID REFERENCES message_campaigns(id),\n  status VARCHAR(20) NOT NULL DEFAULT 'pending',\n  channel_type VARCHAR(20) NOT NULL,\n  created_at TIMESTAMP WITH TIME ZONE,\n  updated_at TIMESTAMP WITH TIME ZONE,\n  sent_at TIMESTAMP WITH TIME ZONE,\n  received_at TIMESTAMP WITH TIME ZONE,\n  converted_at TIMESTAMP WITH TIME ZONE,\n  failed_at TIMESTAMP WITH TIME ZONE,\n  error_reason VARCHAR(255),\n  error_details JSONB DEFAULT '{}',\n  version_history JSONB DEFAULT '{}'\n);\n\n-- \uba54\uc2dc\uc9c0 \uc774\ubca4\ud2b8 \ud14c\uc774\ube14\nCREATE TABLE message_events (\n  id UUID PRIMARY KEY,\n  message_id UUID NOT NULL REFERENCES messages(id),\n  event_type VARCHAR(20) NOT NULL,\n  occurred_at TIMESTAMP WITH TIME ZONE NOT NULL,\n  metadata JSONB DEFAULT '{}'\n);\n\n-- \uad6c\ub3c5 \uc774\ubca4\ud2b8 \ud14c\uc774\ube14\nCREATE TABLE subscription_events (\n  id UUID PRIMARY KEY,\n  user_id UUID REFERENCES users(id),\n  subscription_id UUID NOT NULL REFERENCES subscriptions(id),\n  application_id UUID NOT NULL REFERENCES applications(id),\n  event_type VARCHAR(20) NOT NULL,\n  channel VARCHAR(20),\n  source VARCHAR(50),\n  reason VARCHAR(255),\n  occurred_at TIMESTAMP WITH TIME ZONE NOT NULL\n);\n\n-- \uba54\uc2dc\uc9c0 \ud15c\ud50c\ub9bf \ud14c\uc774\ube14\nCREATE TABLE message_templates (\n  id UUID PRIMARY KEY,\n  application_id UUID NOT NULL REFERENCES applications(id),\n  name VARCHAR(100) NOT NULL,\n  title_template TEXT,\n  body_template TEXT,\n  data_template JSONB DEFAULT '{}',\n  description TEXT,\n  created_at TIMESTAMP WITH TIME ZONE,\n  updated_at TIMESTAMP WITH TIME ZONE,\n  is_active BOOLEAN DEFAULT TRUE,\n  version INTEGER DEFAULT 1\n);\n\n-- \uba54\uc2dc\uc9c0 \ucea0\ud398\uc778 \ud14c\uc774\ube14\nCREATE TABLE message_campaigns (\n  id UUID PRIMARY KEY,\n  application_id UUID NOT NULL REFERENCES applications(id),\n  template_id UUID REFERENCES message_templates(id),\n  name VARCHAR(100) NOT NULL,\n  title TEXT,\n  body TEXT,\n  data JSONB DEFAULT '{}',\n  campaign_type VARCHAR(20) DEFAULT 'immediate',\n  scheduled_at TIMESTAMP WITH TIME ZONE,\n  created_at TIMESTAMP WITH TIME ZONE,\n  updated_at TIMESTAMP WITH TIME ZONE,\n  sent_at TIMESTAMP WITH TIME ZONE,\n  created_by VARCHAR(100),\n  targeting_criteria JSONB DEFAULT '{}',\n  total_recipients INTEGER DEFAULT 0,\n  successful_count INTEGER DEFAULT 0,\n  failed_count INTEGER DEFAULT 0,\n  status VARCHAR(20) DEFAULT 'draft'\n);\n\n-- \uba54\uc2dc\uc9c0 \ud560\ub2f9\ub7c9 \ud14c\uc774\ube14\nCREATE TABLE message_quotas (\n  id UUID PRIMARY KEY,\n  application_id UUID NOT NULL REFERENCES applications(id) UNIQUE,\n  daily_quota INTEGER,\n  monthly_quota INTEGER,\n  daily_used INTEGER DEFAULT 0,\n  monthly_used INTEGER DEFAULT 0,\n  reset_date TIMESTAMP WITH TIME ZONE,\n  unit_price DECIMAL(10, 2),\n  credit_balance DECIMAL(10, 2) DEFAULT 0,\n  billing_currency VARCHAR(3) DEFAULT 'KRW'\n);\n\n-- Oban \uc791\uc5c5 \ud050 \ud14c\uc774\ube14\nCREATE TABLE oban_jobs (\n  id BIGSERIAL PRIMARY KEY,\n  state TEXT NOT NULL DEFAULT 'available',\n  queue TEXT NOT NULL DEFAULT 'default',\n  worker TEXT NOT NULL,\n  args JSONB NOT NULL DEFAULT '{}',\n  errors JSONB[] DEFAULT '{}',\n  attempt INTEGER NOT NULL DEFAULT 0,\n  max_attempts INTEGER NOT NULL DEFAULT 20,\n  inserted_at TIMESTAMP WITH TIME ZONE NOT NULL,\n  scheduled_at TIMESTAMP WITH TIME ZONE NOT NULL,\n  completed_at TIMESTAMP WITH TIME ZONE,\n  attempted_at TIMESTAMP WITH TIME ZONE,\n  cancelled_at TIMESTAMP WITH TIME ZONE,\n  discarded_at TIMESTAMP WITH TIME ZONE,\n  priority INTEGER NOT NULL DEFAULT 0,\n  tags VARCHAR(255)[] DEFAULT '{}',\n  meta JSONB DEFAULT '{}'\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"32-\uc778\ub371\uc2a4-\uc804\ub7b5",children:"3.2 \uc778\ub371\uc2a4 \uc804\ub7b5"}),"\n",(0,i.jsx)(n.p,{children:"\uc131\ub2a5 \ucd5c\uc801\ud654\ub97c \uc704\ud55c \uc778\ub371\uc2a4 \uc124\uc815:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \uc0ac\uc6a9\uc790 \ud14c\uc774\ube14 \uc778\ub371\uc2a4\nCREATE INDEX users_application_id_idx ON users(application_id);\nCREATE INDEX users_external_id_idx ON users(external_id);\nCREATE INDEX users_last_active_at_idx ON users(last_active_at);\n\n-- \uad6c\ub3c5 \ud14c\uc774\ube14 \uc778\ub371\uc2a4\nCREATE INDEX subscriptions_user_id_idx ON subscriptions(user_id);\nCREATE INDEX subscriptions_application_id_idx ON subscriptions(application_id);\nCREATE INDEX subscriptions_token_idx ON subscriptions(token);\nCREATE INDEX subscriptions_type_idx ON subscriptions(type);\nCREATE INDEX subscriptions_status_idx ON subscriptions(subscription_status);\nCREATE INDEX subscriptions_tags_gin_idx ON subscriptions USING GIN (tags);\n\n-- \uba54\uc2dc\uc9c0 \ud14c\uc774\ube14 \uc778\ub371\uc2a4\nCREATE INDEX messages_user_id_idx ON messages(user_id);\nCREATE INDEX messages_subscription_id_idx ON messages(subscription_id);\nCREATE INDEX messages_application_id_idx ON messages(application_id);\nCREATE INDEX messages_campaign_id_idx ON messages(campaign_id);\nCREATE INDEX messages_status_idx ON messages(status);\nCREATE INDEX messages_channel_type_idx ON messages(channel_type);\nCREATE INDEX messages_created_at_idx ON messages(created_at);\n\n-- \uc774\ubca4\ud2b8 \ud14c\uc774\ube14 \uc778\ub371\uc2a4\nCREATE INDEX message_events_message_id_idx ON message_events(message_id);\nCREATE INDEX message_events_event_type_idx ON message_events(event_type);\nCREATE INDEX message_events_occurred_at_idx ON message_events(occurred_at);\n\nCREATE INDEX subscription_events_subscription_id_idx ON subscription_events(subscription_id);\nCREATE INDEX subscription_events_application_id_idx ON subscription_events(application_id);\nCREATE INDEX subscription_events_event_type_idx ON subscription_events(event_type);\nCREATE INDEX subscription_events_occurred_at_idx ON subscription_events(occurred_at);\n\n-- \ucea0\ud398\uc778 \ud14c\uc774\ube14 \uc778\ub371\uc2a4\nCREATE INDEX campaigns_application_id_idx ON message_campaigns(application_id);\nCREATE INDEX campaigns_template_id_idx ON message_campaigns(template_id);\nCREATE INDEX campaigns_status_idx ON message_campaigns(status);\nCREATE INDEX campaigns_scheduled_at_idx ON message_campaigns(scheduled_at);\n\n-- Oban \uc791\uc5c5 \ud050 \uc778\ub371\uc2a4\nCREATE INDEX oban_jobs_state_idx ON oban_jobs(state);\nCREATE INDEX oban_jobs_queue_state_idx ON oban_jobs(queue, state);\nCREATE INDEX oban_jobs_scheduled_at_idx ON oban_jobs(scheduled_at);\nCREATE INDEX oban_jobs_tags_idx ON oban_jobs USING GIN (tags);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"33-\ud30c\ud2f0\uc154\ub2dd-\uc804\ub7b5",children:"3.3 \ud30c\ud2f0\uc154\ub2dd \uc804\ub7b5"}),"\n",(0,i.jsx)(n.p,{children:"\uba54\uc2dc\uc9c0 \ubc0f \uc774\ubca4\ud2b8 \ud14c\uc774\ube14\uc740 \ub300\ub7c9\uc758 \ub370\uc774\ud130\ub97c \ucc98\ub9ac\ud558\uae30 \uc704\ud574 \ud30c\ud2f0\uc154\ub2dd\uc744 \uc801\uc6a9\ud569\ub2c8\ub2e4:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \uba54\uc2dc\uc9c0 \ud14c\uc774\ube14 \ud30c\ud2f0\uc154\ub2dd (\uc6d4\ubcc4)\nCREATE TABLE messages_y2025m04 PARTITION OF messages\n  FOR VALUES FROM ('2025-04-01') TO ('2025-05-01');\n\nCREATE TABLE messages_y2025m05 PARTITION OF messages\n  FOR VALUES FROM ('2025-05-01') TO ('2025-06-01');\n\n-- \uba54\uc2dc\uc9c0 \uc774\ubca4\ud2b8 \ud14c\uc774\ube14 \ud30c\ud2f0\uc154\ub2dd (\uc6d4\ubcc4)\nCREATE TABLE message_events_y2025m04 PARTITION OF message_events\n  FOR VALUES FROM ('2025-04-01') TO ('2025-05-01');\n\nCREATE TABLE message_events_y2025m05 PARTITION OF message_events\n  FOR VALUES FROM ('2025-05-01') TO ('2025-06-01');\n\n-- \uad6c\ub3c5 \uc774\ubca4\ud2b8 \ud14c\uc774\ube14 \ud30c\ud2f0\uc154\ub2dd (\uc6d4\ubcc4)\nCREATE TABLE subscription_events_y2025m04 PARTITION OF subscription_events\n  FOR VALUES FROM ('2025-04-01') TO ('2025-05-01');\n\nCREATE TABLE subscription_events_y2025m05 PARTITION OF subscription_events\n  FOR VALUES FROM ('2025-05-01') TO ('2025-06-01');\n"})}),"\n",(0,i.jsx)(n.h2,{id:"4-\ub370\uc774\ud130-\uad00\uacc4-\ubc0f-\uc81c\uc57d\uc870\uac74",children:"4. \ub370\uc774\ud130 \uad00\uacc4 \ubc0f \uc81c\uc57d\uc870\uac74"}),"\n",(0,i.jsx)(n.h3,{id:"41-\uc8fc\uc694-\uad00\uacc4",children:"4.1 \uc8fc\uc694 \uad00\uacc4"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Application-User"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc740 \uc5ec\ub7ec \uc0ac\uc6a9\uc790\ub97c \uac00\uc9c8 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"User-Subscription"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \uc0ac\uc6a9\uc790\ub294 \uc5ec\ub7ec \uad6c\ub3c5\uc744 \uac00\uc9c8 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Application-Subscription"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc740 \uc5ec\ub7ec \uad6c\ub3c5\uc744 \uac00\uc9c8 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Subscription-Message"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \uad6c\ub3c5\uc740 \uc5ec\ub7ec \uba54\uc2dc\uc9c0\ub97c \uc218\uc2e0\ud560 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"User-Message"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \uc0ac\uc6a9\uc790\ub294 \uc5ec\ub7ec \uba54\uc2dc\uc9c0\ub97c \uc218\uc2e0\ud560 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Message-MessageEvent"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \uba54\uc2dc\uc9c0\ub294 \uc5ec\ub7ec \uc774\ubca4\ud2b8\ub97c \uc0dd\uc131\ud560 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Template-Campaign"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \ud15c\ud50c\ub9bf\uc740 \uc5ec\ub7ec \ucea0\ud398\uc778\uc5d0\uc11c \uc0ac\uc6a9\ub420 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Campaign-Message"}),": \uc77c\ub300\ub2e4 \uad00\uacc4. \ud558\ub098\uc758 \ucea0\ud398\uc778\uc740 \uc5ec\ub7ec \uba54\uc2dc\uc9c0\ub97c \uc0dd\uc131\ud560 \uc218 \uc788\uc74c."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Application-MessageQuota"}),": \uc77c\ub300\uc77c \uad00\uacc4. \ud558\ub098\uc758 \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc740 \ud558\ub098\uc758 \ud560\ub2f9\ub7c9 \uc124\uc815\uc744 \uac00\uc9d0."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"42-\uc911\uc694-\uc81c\uc57d\uc870\uac74",children:"4.2 \uc911\uc694 \uc81c\uc57d\uc870\uac74"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"User.external_id + User.application_id"}),": \ubcf5\ud569 \uc720\ub2c8\ud06c \uc81c\uc57d\uc870\uac74. \uc560\ud50c\ub9ac\ucf00\uc774\uc158 \ub0b4\uc5d0\uc11c \uc0ac\uc6a9\uc790 \uc2dd\ubcc4\uc790\ub294 \uace0\uc720\ud574\uc57c \ud568."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Application-MessageQuota"}),": \uc77c\ub300\uc77c \uc81c\uc57d\uc870\uac74. \uc560\ud50c\ub9ac\ucf00\uc774\uc158\ub2f9 \ud558\ub098\uc758 \ud560\ub2f9\ub7c9 \uc124\uc815\ub9cc \ud5c8\uc6a9."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Foreign Key \uc81c\uc57d\uc870\uac74"}),": \ubaa8\ub4e0 \uad00\uacc4\ub294 \uc678\ub798 \ud0a4 \uc81c\uc57d\uc870\uac74\uc73c\ub85c \ubcf4\ud638\ub428."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"NOT NULL \uc81c\uc57d\uc870\uac74"}),": \ud575\uc2ec \ud544\ub4dc\ub294 NULL \uac12\uc744 \ud5c8\uc6a9\ud558\uc9c0 \uc54a\uc74c (application_id, token, type \ub4f1)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Enum \uc81c\uc57d\uc870\uac74"}),": \uc0c1\ud0dc, \uc720\ud615 \ub4f1\uc758 \ud544\ub4dc\ub294 \ubbf8\ub9ac \uc815\uc758\ub41c \uac12\ub9cc \ud5c8\uc6a9."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"5-\ub370\uc774\ud130-\ub9c8\uc774\uadf8\ub808\uc774\uc158-\ubc0f-\uc9c4\ud654",children:"5. \ub370\uc774\ud130 \ub9c8\uc774\uadf8\ub808\uc774\uc158 \ubc0f \uc9c4\ud654"}),"\n",(0,i.jsx)(n.h3,{id:"51-\uc2a4\ud0a4\ub9c8-\ubcc0\uacbd-\uc804\ub7b5",children:"5.1 \uc2a4\ud0a4\ub9c8 \ubcc0\uacbd \uc804\ub7b5"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\uc810\uc9c4\uc801 \ub9c8\uc774\uadf8\ub808\uc774\uc158"}),": \ud558\uc704 \ud638\ud658\uc131\uc744 \uc720\uc9c0\ud558\uba74\uc11c \uc810\uc9c4\uc801\uc778 \uc2a4\ud0a4\ub9c8 \ubcc0\uacbd"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ub864\ubc31 \uacc4\ud68d"}),": \ubaa8\ub4e0 \ub9c8\uc774\uadf8\ub808\uc774\uc158\uc5d0 \ub864\ubc31 \uacc4\ud68d \ud3ec\ud568"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ubb34\uc911\ub2e8 \ub9c8\uc774\uadf8\ub808\uc774\uc158"}),": \uc11c\ube44\uc2a4 \uc911\ub2e8 \uc5c6\uc774 \uc2a4\ud0a4\ub9c8 \ubcc0\uacbd \uc218\ud589"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"52-\ub9c8\uc774\uadf8\ub808\uc774\uc158-\uac00\uc774\ub4dc\ub77c\uc778",children:"5.2 \ub9c8\uc774\uadf8\ub808\uc774\uc158 \uac00\uc774\ub4dc\ub77c\uc778"}),"\n",(0,i.jsx)(n.p,{children:"\uc0c8\ub85c\uc6b4 \ud544\ub4dc \ucd94\uac00:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"# \ub9c8\uc774\uadf8\ub808\uc774\uc158 \uc608\uc2dc\ndefmodule AutomataSignal.Repo.Migrations.AddDeviceLanguageToSubscription do\n  use Ecto.Migration\n\n  def change do\n    alter table(:subscriptions) do\n      add :device_language, :string, size: 10\n    end\n  end\nend\n"})}),"\n",(0,i.jsx)(n.p,{children:"\ud544\ub4dc \uc720\ud615 \ubcc0\uacbd:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'# \ub9c8\uc774\uadf8\ub808\uc774\uc158 \uc608\uc2dc\ndefmodule AutomataSignal.Repo.Migrations.ChangeStatusToEnum do\n  use Ecto.Migration\n\n  def up do\n    # \uc784\uc2dc \uceec\ub7fc \ucd94\uac00\n    alter table(:messages) do\n      add :status_new, :message_status\n    end\n\n    # \ub370\uc774\ud130 \ubcf5\uc0ac\n    execute """\n    UPDATE messages\n    SET status_new = status::message_status\n    """\n\n    # \uae30\uc874 \uceec\ub7fc \uc0ad\uc81c \ubc0f \uc774\ub984 \ubcc0\uacbd\n    alter table(:messages) do\n      remove :status\n      rename :status_new, to: :status\n    end\n  end\n\n  def down do\n    # \ub864\ubc31 \ub85c\uc9c1\n    # ...\n  end\nend\n'})}),"\n",(0,i.jsx)(n.p,{children:"\ud14c\uc774\ube14 \ud30c\ud2f0\uc154\ub2dd:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'defmodule AutomataSignal.Repo.Migrations.PartitionMessagesTable do\n  use Ecto.Migration\n\n  def up do\n    # \uc784\uc2dc \ud14c\uc774\ube14 \uc0dd\uc131\n    execute """\n    CREATE TABLE messages_new (\n      id UUID NOT NULL,\n      -- \ub2e4\ub978 \ud544\ub4dc\ub4e4...\n      created_at TIMESTAMP WITH TIME ZONE NOT NULL\n    ) PARTITION BY RANGE (created_at);\n    """\n\n    # \uae30\uc874 \ub370\uc774\ud130 \ubcf5\uc0ac\n    execute "INSERT INTO messages_new SELECT * FROM messages"\n\n    # \ud30c\ud2f0\uc158 \uc0dd\uc131\n    execute """\n    CREATE TABLE messages_y2025m04 PARTITION OF messages_new\n      FOR VALUES FROM (\'2025-04-01\') TO (\'2025-05-01\');\n    """\n\n    # \ud14c\uc774\ube14 \uad50\uccb4\n    execute "DROP TABLE messages"\n    execute "ALTER TABLE messages_new RENAME TO messages"\n  end\n\n  def down do\n    # \ub864\ubc31 \ub85c\uc9c1\n    # ...\n  end\nend\n'})}),"\n",(0,i.jsx)(n.h3,{id:"53-\ubc84\uc804-\uad00\ub9ac",children:"5.3 \ubc84\uc804 \uad00\ub9ac"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\uc2a4\ud0a4\ub9c8 \ubc84\uc804 \ucd94\uc801"}),": \ub370\uc774\ud130\ubca0\uc774\uc2a4 \uc2a4\ud0a4\ub9c8 \ubc84\uc804 \uba85\uc2dc\uc801 \ucd94\uc801"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ub9c8\uc774\uadf8\ub808\uc774\uc158 \ub9b4\ub9ac\uc2a4 \uacc4\ud68d"}),": \ub9c8\uc774\uadf8\ub808\uc774\uc158\uacfc \ucf54\ub4dc \ub9b4\ub9ac\uc2a4 \uc870\uc815"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\uc774\uc804 \ubc84\uc804 \ud638\ud658\uc131"}),": \ud544\uc694\ud55c \uacbd\uc6b0 \uc774\uc804 \ubc84\uc804 \uc2a4\ud0a4\ub9c8\uc640\uc758 \ud638\ud658\uc131 \uc720\uc9c0"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"6-\uc131\ub2a5-\ucd5c\uc801\ud654",children:"6. \uc131\ub2a5 \ucd5c\uc801\ud654"}),"\n",(0,i.jsx)(n.h3,{id:"61-\uc870\ud68c-\ucd5c\uc801\ud654",children:"6.1 \uc870\ud68c \ucd5c\uc801\ud654"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\uc778\ub371\uc2a4 \uc804\ub7b5"}),": \uc790\uc8fc \uc870\ud68c\ub418\ub294 \ud544\ub4dc\uc5d0 \uc778\ub371\uc2a4 \uc801\uc6a9"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ubcf5\ud569 \uc778\ub371\uc2a4"}),": \ud568\uaed8 \uc870\ud68c\ub418\ub294 \ud544\ub4dc\uc5d0 \ubcf5\ud569 \uc778\ub371\uc2a4 \uc801\uc6a9"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ubd80\ubd84 \uc778\ub371\uc2a4"}),": \ud2b9\uc815 \uc870\uac74\uc5d0 \ub300\ud55c \ubd80\ubd84 \uc778\ub371\uc2a4 \ud65c\uc6a9"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \ud65c\uc131 \uad6c\ub3c5\ub9cc\uc744 \uc704\ud55c \ubd80\ubd84 \uc778\ub371\uc2a4\nCREATE INDEX active_subscriptions_idx ON subscriptions(application_id, type)\nWHERE subscription_status > 0;\n\n-- \ud0dc\uadf8 \uae30\ubc18 \uac80\uc0c9\uc744 \uc704\ud55c GIN \uc778\ub371\uc2a4\nCREATE INDEX subscriptions_tags_gin_idx ON subscriptions USING GIN (tags);\n\n-- \uba54\uc2dc\uc9c0 \uc0c1\ud0dc \ubc0f \uc0dd\uc131 \uc2dc\uac04 \ubcf5\ud569 \uc778\ub371\uc2a4\nCREATE INDEX messages_status_created_idx ON messages(status, created_at);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"62-\uc785\ub825\uc218\uc815-\ucd5c\uc801\ud654",children:"6.2 \uc785\ub825/\uc218\uc815 \ucd5c\uc801\ud654"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ubc30\uce58 \uc0bd\uc785"}),": \ub300\ub7c9 \ub370\uc774\ud130 \uc0bd\uc785 \uc2dc \ubc30\uce58 \ucc98\ub9ac"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ubd80\ubd84 \uc5c5\ub370\uc774\ud2b8"}),": \ud544\uc694\ud55c \ud544\ub4dc\ub9cc \uc5c5\ub370\uc774\ud2b8"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ub099\uad00\uc801 \uc7a0\uae08"}),": \ub3d9\uc2dc \uc5c5\ub370\uc774\ud2b8 \ucc98\ub9ac\ub97c \uc704\ud55c \ub099\uad00\uc801 \uc7a0\uae08 \ud65c\uc6a9"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"63-\uc2e4\ud589-\uacc4\ud68d-\ubd84\uc11d",children:"6.3 \uc2e4\ud589 \uacc4\ud68d \ubd84\uc11d"}),"\n",(0,i.jsx)(n.p,{children:"\uc911\uc694 \ucffc\ub9ac\uc758 \uc2e4\ud589 \uacc4\ud68d \ubd84\uc11d \ubc0f \ucd5c\uc801\ud654:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"EXPLAIN ANALYZE\nSELECT * FROM messages\nWHERE application_id = '123e4567-e89b-12d3-a456-426614174000'\nAND status = 'pending'\nORDER BY created_at DESC\nLIMIT 100;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"64-\ub300\ub7c9-\ucffc\ub9ac-\uc804\ub7b5",children:"6.4 \ub300\ub7c9 \ucffc\ub9ac \uc804\ub7b5"}),"\n",(0,i.jsx)(n.p,{children:"\ub300\ub7c9 \ub370\uc774\ud130 \ucc98\ub9ac\ub97c \uc704\ud55c \uc804\ub7b5:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ucee4\uc11c \uae30\ubc18 \ud398\uc774\uc9d5"}),": offset \ub300\uc2e0 \ucee4\uc11c \uae30\ubc18 \ud398\uc774\uc9d5 \uc0ac\uc6a9"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\uc2a4\ud2b8\ub9ac\ubc0d \ucc98\ub9ac"}),": \ub300\ub7c9 \ub370\uc774\ud130\ub97c \uc2a4\ud2b8\ub9bc\uc73c\ub85c \ucc98\ub9ac"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\ube44\ub3d9\uae30 \ubc30\uce58 \ucc98\ub9ac"}),": \ub300\ub7c9 \uc791\uc5c5\uc744 \ube44\ub3d9\uae30 \ubc30\uce58\ub85c \ucc98\ub9ac"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"# \ucee4\uc11c \uae30\ubc18 \ud398\uc774\uc9d5 \uc608\uc2dc\ndef list_messages_after(application_id, cursor, limit) do\n  query = from m in Message,\n    where: m.application_id == ^application_id,\n    where: m.id > ^cursor,\n    order_by: [asc: m.id],\n    limit: ^limit\n\n  Repo.all(query)\nend\n\n# \uc2a4\ud2b8\ub9ac\ubc0d \ucc98\ub9ac \uc608\uc2dc\ndef stream_all_messages(application_id) do\n  Message\n  |> where([m], m.application_id == ^application_id)\n  |> order_by([m], m.id)\n  |> Repo.stream()\nend\n"})}),"\n",(0,i.jsx)(n.h2,{id:"7-\ubcf4\uc548-\uace0\ub824\uc0ac\ud56d",children:"7. \ubcf4\uc548 \uace0\ub824\uc0ac\ud56d"}),"\n",(0,i.jsx)(n.h3,{id:"71-\ubbfc\uac10-\ub370\uc774\ud130-\ucc98\ub9ac",children:"7.1 \ubbfc\uac10 \ub370\uc774\ud130 \ucc98\ub9ac"}),"\n",(0,i.jsx)(n.p,{children:"\ubbfc\uac10\ud55c \ub370\uc774\ud130\ub294 ash_cloak\uc744 \uc0ac\uc6a9\ud558\uc5ec \uc554\ud638\ud654\ub429\ub2c8\ub2e4:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.Subscription do\n  use Ash.Resource,\n    # ...\n    extensions: [AshCloak.Resource]\n\n  # ...\n\n  encrypted_attributes do\n    attribute :token\n  end\n\n  # ...\nend\n"})}),"\n",(0,i.jsx)(n.p,{children:"\uc554\ud638\ud654 \uc124\uc815:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'config :ash_cloak, repo: AutomataSignal.Repo\n\nconfig :ash_cloak, AutomataSignal.AES,\n  keys: [\n    %{tag: "1", key: :base64.decode("..."), default: true}\n  ]\n'})}),"\n",(0,i.jsx)(n.h3,{id:"72-\uc811\uadfc-\uc81c\uc5b4",children:"7.2 \uc811\uadfc \uc81c\uc5b4"}),"\n",(0,i.jsx)(n.p,{children:"\ub370\uc774\ud130 \uc811\uadfc \uc81c\uc5b4:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.Application do\n  # ...\n\n  actions do\n    # ...\n\n    # API \ud0a4 \uc778\uc99d \uc815\ucc45\n    defaults [:create, :read, :update, :destroy], policy: [AutomataSignal.Policies.RequireApiKey]\n  end\nend\n"})}),"\n",(0,i.jsx)(n.p,{children:"\uc778\uc99d \uc815\ucc45 \uad6c\ud604:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Policies.RequireApiKey do\n  use Ash.Policy.SimpleCheck\n\n  def check(actor, _resource, _action) do\n    case actor do\n      %{api_key: key} when is_binary(key) ->\n        # API \ud0a4 \uac80\uc99d \ub85c\uc9c1\n        # ...\n        true\n      _ ->\n        false\n    end\n  end\nend\n"})}),"\n",(0,i.jsx)(n.h3,{id:"73-\uac10\uc0ac-\ucd94\uc801",children:"7.3 \uac10\uc0ac \ucd94\uc801"}),"\n",(0,i.jsx)(n.p,{children:"ash_paper_trail\uc744 \uc0ac\uc6a9\ud55c \ubcc0\uacbd \uc774\ub825 \ucd94\uc801:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Resources.MessageEvent do\n  use Ash.Resource,\n    # ...\n    extensions: [AshPaperTrail.Resource]\n\n  # ...\n\n  paper_trail do\n    track_attribute :event_type\n    track_attribute :metadata\n\n    track_relationship_updates? true\n\n    monitor_actor? true\n    track_actor? true\n  end\n\n  # ...\nend\n"})}),"\n",(0,i.jsx)(n.h2,{id:"8-\ub370\uc774\ud130-\ub9c8\uc774\uadf8\ub808\uc774\uc158-\uc2a4\ud06c\ub9bd\ud2b8",children:"8. \ub370\uc774\ud130 \ub9c8\uc774\uadf8\ub808\uc774\uc158 \uc2a4\ud06c\ub9bd\ud2b8"}),"\n",(0,i.jsx)(n.h3,{id:"81-\uae30\ubcf8-\uc2a4\ud0a4\ub9c8-\uc0dd\uc131",children:"8.1 \uae30\ubcf8 \uc2a4\ud0a4\ub9c8 \uc0dd\uc131"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'defmodule AutomataSignal.Repo.Migrations.CreateBaseSchema do\n  use Ecto.Migration\n\n  def change do\n    # \uc560\ud50c\ub9ac\ucf00\uc774\uc158 \ud14c\uc774\ube14\n    create table(:applications, primary_key: false) do\n      add :id, :uuid, primary_key: true\n      add :name, :string, size: 100, null: false\n      add :api_key, :string, size: 255, null: false\n      add :settings, :jsonb, default: "{}"\n\n      timestamps()\n\n      add :is_active, :boolean, default: true\n    end\n\n    create index(:applications, [:name])\n    create unique_index(:applications, [:api_key])\n\n    # \uc0ac\uc6a9\uc790 \ud14c\uc774\ube14\n    create table(:users, primary_key: false) do\n      add :id, :uuid, primary_key: true\n      add :external_id, :string, size: 255, null: false\n      add :application_id, references(:applications, type: :uuid), null: false\n\n      add :created_at, :utc_datetime\n      add :last_active_at, :utc_datetime\n\n      add :is_archived, :boolean, default: false\n      add :archived_at, :utc_datetime\n    end\n\n    create index(:users, [:application_id])\n    create index(:users, [:external_id])\n    create unique_index(:users, [:external_id, :application_id])\n\n    # \uad6c\ub3c5 \ud14c\uc774\ube14\n    create table(:subscriptions, primary_key: false) do\n      add :id, :uuid, primary_key: true\n      add :token, :text, null: false\n      add :type, :string, size: 20, null: false\n      add :user_id, references(:users, type: :uuid)\n      add :application_id, references(:applications, type: :uuid), null: false\n\n      # \ub514\ubc14\uc774\uc2a4 \uc815\ubcf4\n      add :device_model, :string, size: 255\n      add :device_os, :string, size: 255\n      add :device_language, :string, size: 10\n      add :app_version, :string, size: 20\n      add :sdk_version, :string, size: 20\n      add :country_code, :string, size: 10\n      add :test_type, :integer, default: 0\n\n      # \uad6c\ub3c5 \uc0c1\ud0dc\n      add :subscription_status, :integer, default: 0\n      add :subscribed_at, :utc_datetime\n      add :unsubscribed_at, :utc_datetime\n\n      # \ud0dc\uadf8\n      add :tags, :jsonb, default: "{}"\n\n      # \ud1b5\uacc4\n      add :last_active_at, :utc_datetime\n      add :total_messages_received, :integer, default: 0\n      add :total_messages_converted, :integer, default: 0\n\n      add :is_archived, :boolean, default: false\n      add :archived_at, :utc_datetime\n    end\n\n    # ... \ub098\uba38\uc9c0 \ud14c\uc774\ube14 \uc0dd\uc131 ...\n\n    # \uc778\ub371\uc2a4 \uc0dd\uc131\n    create index(:subscriptions, [:user_id])\n    create index(:subscriptions, [:application_id])\n    create index(:subscriptions, [:type])\n    create index(:subscriptions, [:subscription_status])\n    create index(:subscriptions, :tags, using: :gin)\n\n    # ... \ub098\uba38\uc9c0 \uc778\ub371\uc2a4 \uc0dd\uc131 ...\n  end\nend\n'})}),"\n",(0,i.jsx)(n.h3,{id:"82-\ud14c\uc774\ube14-\ud30c\ud2f0\uc154\ub2dd-\ub9c8\uc774\uadf8\ub808\uc774\uc158",children:"8.2 \ud14c\uc774\ube14 \ud30c\ud2f0\uc154\ub2dd \ub9c8\uc774\uadf8\ub808\uc774\uc158"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'defmodule AutomataSignal.Repo.Migrations.CreateTablePartitions do\n  use Ecto.Migration\n\n  def up do\n    # \uba54\uc2dc\uc9c0 \ud14c\uc774\ube14 \ud30c\ud2f0\uc154\ub2dd\n    execute """\n    CREATE TABLE messages_partitioned (\n      LIKE messages INCLUDING ALL\n    ) PARTITION BY RANGE (created_at);\n    """\n\n    # \ucd08\uae30 \ud30c\ud2f0\uc158 \uc0dd\uc131\n    execute """\n    CREATE TABLE messages_y2025m04 PARTITION OF messages_partitioned\n      FOR VALUES FROM (\'2025-04-01\') TO (\'2025-05-01\');\n    """\n\n    execute """\n    CREATE TABLE messages_y2025m05 PARTITION OF messages_partitioned\n      FOR VALUES FROM (\'2025-05-01\') TO (\'2025-06-01\');\n    """\n\n    # \ub370\uc774\ud130 \ub9c8\uc774\uadf8\ub808\uc774\uc158\n    execute "INSERT INTO messages_partitioned SELECT * FROM messages;"\n\n    # \ud14c\uc774\ube14 \uad50\uccb4\n    execute "DROP TABLE messages CASCADE;"\n    execute "ALTER TABLE messages_partitioned RENAME TO messages;"\n\n    # ... \ub2e4\ub978 \ud14c\uc774\ube14\uc5d0 \ub300\ud574\uc11c\ub3c4 \ub3d9\uc77c\ud55c \uacfc\uc815 \ubc18\ubcf5 ...\n  end\n\n  def down do\n    # \ub864\ubc31 \ub85c\uc9c1\n    # ...\n  end\nend\n'})}),"\n",(0,i.jsx)(n.h2,{id:"9-\ub370\uc774\ud130-\ubaa8\ub378-\uc0ac\uc6a9-\uc608\uc2dc",children:"9. \ub370\uc774\ud130 \ubaa8\ub378 \uc0ac\uc6a9 \uc608\uc2dc"}),"\n",(0,i.jsx)(n.h3,{id:"91-\uad6c\ub3c5-\ub4f1\ub85d",children:"9.1 \uad6c\ub3c5 \ub4f1\ub85d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Services.SubscriptionService do\n  alias AutomataSignal.Resources.Subscription\n\n  def register_subscription(params) do\n    Subscription.register(params)\n    |> case do\n      {:ok, subscription} ->\n        # \uad6c\ub3c5 \ub4f1\ub85d \uc774\ubca4\ud2b8 \uc0dd\uc131\n        create_subscription_event(subscription, :created)\n        {:ok, subscription}\n\n      {:error, error} ->\n        {:error, error}\n    end\n  end\n\n  def create_subscription_event(subscription, event_type, reason \\\\ nil) do\n    # \uad6c\ub3c5 \uc774\ubca4\ud2b8 \uc0dd\uc131 \ub85c\uc9c1\n    # ...\n  end\nend\n"})}),"\n",(0,i.jsx)(n.h3,{id:"92-\uba54\uc2dc\uc9c0-\uc804\uc1a1",children:"9.2 \uba54\uc2dc\uc9c0 \uc804\uc1a1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:"defmodule AutomataSignal.Services.MessageService do\n  alias AutomataSignal.Resources.Message\n  alias AutomataSignal.Resources.MessageEvent\n\n  def send_message(params) do\n    # \uc0ac\uc6a9\ub7c9 \ud655\uc778\n    with {:ok, _} <- check_quota(params.application_id),\n         {:ok, message} <- create_message(params) do\n\n      # \uc791\uc5c5 \ud050\uc5d0 \ucd94\uac00\n      schedule_message_delivery(message)\n\n      {:ok, message}\n    else\n      {:error, reason} -> {:error, reason}\n    end\n  end\n\n  defp create_message(params) do\n    # \ud15c\ud50c\ub9bf \ucc98\ub9ac\n    params = if params[:use_template] do\n      process_template(params)\n    else\n      params\n    end\n\n    # \uba54\uc2dc\uc9c0 \uc0dd\uc131\n    Message.send_message(params)\n  end\n\n  defp process_template(%{template_id: template_id, template_variables: variables} = params) do\n    # \ud15c\ud50c\ub9bf \ub80c\ub354\ub9c1 \ub85c\uc9c1\n    # ...\n  end\n\n  defp schedule_message_delivery(message) do\n    # \uc791\uc5c5 \ud050\uc5d0 \uc804\uc1a1 \uc791\uc5c5 \ucd94\uac00\n    # ...\n  end\n\n  defp check_quota(application_id) do\n    # \ud560\ub2f9\ub7c9 \ud655\uc778 \ub85c\uc9c1\n    # ...\n  end\nend\n"})}),"\n",(0,i.jsx)(n.h3,{id:"93-\ucea0\ud398\uc778-\uc0dd\uc131-\ubc0f-\uc2e4\ud589",children:"9.3 \ucea0\ud398\uc778 \uc0dd\uc131 \ubc0f \uc2e4\ud589"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-elixir",children:'defmodule AutomataSignal.Services.CampaignService do\n  alias AutomataSignal.Resources.MessageCampaign\n  alias AutomataSignal.Resources.Subscription\n\n  def create_campaign(params) do\n    MessageCampaign.create(params)\n  end\n\n  def execute_campaign(campaign_id) do\n    with {:ok, campaign} <- get_campaign(campaign_id),\n         {:ok, updated_campaign} <- MessageCampaign.execute(%{id: campaign_id}),\n         {:ok, subscriptions} <- find_target_subscriptions(campaign) do\n\n      # \ud0c0\uac9f\ud305\ub41c \uad6c\ub3c5 \uc218 \uc5c5\ub370\uc774\ud2b8\n      update_campaign_recipients(campaign.id, length(subscriptions))\n\n      # \ubc30\uce58 \ucc98\ub9ac\n      process_campaign_messages(campaign, subscriptions)\n\n      {:ok, updated_campaign}\n    else\n      {:error, reason} -> {:error, reason}\n    end\n  end\n\n  defp get_campaign(id) do\n    # \ucea0\ud398\uc778 \uc870\ud68c\n    # ...\n  end\n\n  defp find_target_subscriptions(campaign) do\n    # \ud0c0\uac9f\ud305 \uc870\uac74\uc5d0 \ub9de\ub294 \uad6c\ub3c5 \ucc3e\uae30\n    criteria = campaign.targeting_criteria\n\n    query = Subscription.query()\n      |> Ash.Query.filter(application_id == ^campaign.application_id)\n      |> Ash.Query.filter(subscription_status > 0)\n\n    # \ud0dc\uadf8 \ud544\ud130 \uc801\uc6a9\n    query = if criteria["tags"] do\n      apply_tag_filters(query, criteria["tags"])\n    else\n      query\n    end\n\n    # \ud65c\ub3d9 \uc2dc\uac04 \ud544\ud130 \uc801\uc6a9\n    query = if criteria["last_active_after"] do\n      Ash.Query.filter(query, last_active_at > ^criteria["last_active_after"])\n    else\n      query\n    end\n\n    # \uad6d\uac00 \ud544\ud130 \uc801\uc6a9\n    query = if criteria["countries"] do\n      Ash.Query.filter(query, country_code in ^criteria["countries"])\n    else\n      query\n    end\n\n    # \ucffc\ub9ac \uc2e4\ud589\n    {:ok, Ash.read!(query)}\n  end\n\n  defp apply_tag_filters(query, tags) do\n    Enum.reduce(tags, query, fn {key, value}, acc ->\n      Ash.Query.filter(acc, fragment("(tags->?)::text = ?", ^key, ^value))\n    end)\n  end\n\n  defp update_campaign_recipients(campaign_id, count) do\n    # \ucea0\ud398\uc778 \uc218\uc2e0\uc790 \uc218 \uc5c5\ub370\uc774\ud2b8\n    # ...\n  end\n\n  defp process_campaign_messages(campaign, subscriptions) do\n    # \ubc30\uce58 \ucc98\ub9ac\n    subscriptions\n    |> Enum.chunk_every(500)\n    |> Enum.each(fn batch ->\n      # \ubc30\uce58 \ub2e8\uc704\ub85c \uba54\uc2dc\uc9c0 \uc0dd\uc131 \ubc0f \uc791\uc5c5 \ucd94\uac00\n      # ...\n    end)\n  end\nend\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}}}]);